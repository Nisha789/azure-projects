
# üè° AirBnB CDC Ingestion Pipeline

## Project Overview

The **AirBnB CDC Ingestion Pipeline** is designed to efficiently ingest, transform, and aggregate data from two sources: **Customer** and **Bookings**. This pipeline leverages Azure's **data engineering ecosystem**, including **Azure Data Lake Storage (ADLS)**, **Cosmos DB**, **Azure Data Factory (ADF)**, and **Azure Synapse Analytics**, to ensure real-time and batch processing of booking data.

---

## üõ†Ô∏è Tools and Technologies

- **Azure Data Lake Storage (ADLS)** ‚Äì Raw & archive storage for datasets
- **Azure Cosmos DB** ‚Äì Real-time/CDC (Change Data Capture) storage for bookings data
- **Azure Data Factory (ADF)** ‚Äì Orchestration and data pipeline management
- **Azure Synapse Analytics** ‚Äì Data warehousing, storage, and transformation
- **Python** ‚Äì Mock booking data generation
- **SQL** ‚Äì Data transformation, aggregation, and stored procedures

---

## üöÄ Architecture Overview

```plaintext
                       +-----------------+
                       |  Customer Data  |
                       |  (every 30 mins)|
                       +--------+--------+
                                |
                                v
                        [ADLS - Raw Folder]
                                |
                                v
                       [Azure Data Factory]
                                |
                                v
                        [Synapse Table Load]
                                |
                                v
                  [Move to Archive + Clean Raw]

         +---------------------------------------------+

                       +------------------+
                       |   Booking Data   |
                       | (Simulated CDC)  |
                       +--------+---------+
                                |
                  [Python Script ‚Üí Cosmos DB]
                                |
                                v
                       [ADF or Synapse Link]
                                |
                                v
                    [Transform + Load to Synapse]

```

---

## üìä Data Flow

### **1. Customer Data Ingestion** (Batch)

- Every **30 minutes**, new **customer data** arrives in the **ADLS raw folder**.
- The data is then ingested into **Azure Synapse** using **Azure Data Factory (ADF)**.
- Once the data is loaded into **Synapse**, it is archived and deleted from the **raw folder** for efficient storage management.

### **2. Booking Data Ingestion** (CDC)

- **Mock booking data** is generated by a Python script and stored in **Azure Cosmos DB**.
- The data is ingested into **Azure Synapse** through **Azure Data Factory** or **Synapse Link** for **real-time processing**.
- This process handles **CDC** (Change Data Capture), which ensures that only **new or updated records** are processed, reducing unnecessary data movement.

### **3. Aggregation and Reporting**

- An **aggregation** logic is implemented to compute insights like:
  - Total bookings per country
  - Total amount spent per country
  - Last booking date per country
- This is done by joining the **bookings_fact** table with the **customer_dim** table and creating the **BookingCustomerAggregation** table in **Synapse**.

---

## üßÆ Data Transformation & Aggregation

### **Table: airbnb.BookingCustomerAggregation**

The aggregation table is created with a **Round-Robin Distribution** to ensure efficient querying and data management.

```sql
CREATE TABLE airbnb.BookingCustomerAggregation
WITH (DISTRIBUTION = ROUND_ROBIN)
AS
SELECT 
    c.country,
    COUNT_BIG(*) AS total_bookings,
    SUM(ISNULL(b.amount, 0)) AS total_amount,
    MAX(b.booking_date) AS last_booking_date
FROM 
    airbnb.bookings_fact b
JOIN 
    airbnb.customer_dim c ON b.customer_id = c.customer_id
GROUP BY 
    c.country;
```

### **Stored Procedure: airbnb.BookingAggregation**

To refresh the aggregated data regularly, a stored procedure is used:

```sql
CREATE PROCEDURE airbnb.BookingAggregation
AS
BEGIN
    TRUNCATE TABLE airbnb.BookingCustomerAggregation;

    INSERT INTO airbnb.BookingCustomerAggregation
    SELECT 
        c.country,
        COUNT_BIG(*) AS total_bookings,
        SUM(ISNULL(b.amount, 0)) AS total_amount,
        MAX(b.booking_date) AS last_booking_date
    FROM 
        airbnb.bookings_fact b
    JOIN 
        airbnb.customer_dim c ON b.customer_id = c.customer_id
    GROUP BY 
        c.country;
END;
```

The stored procedure is executed using:

```sql
EXEC airbnb.BookingAggregation;
```

---

## ‚öôÔ∏è Project Workflow

### 1. **Mock Data Generation**
Run the Python script to generate mock booking data in **Cosmos DB**.

```bash
python mock_data_in_cosmosdb.py
```

### 2. **Customer Data Ingestion**
Set up an **ADF pipeline** to:
- Copy data from ADLS raw to Synapse.
- Archive and delete raw files after ingestion.

### 3. **Booking Data Ingestion (CDC)**
- Set up **ADF** or **Synapse Link** to:
  - Ingest new or changed bookings from **Cosmos DB** into **Synapse**.
  - Apply transformations as needed.

### 4. **Data Aggregation**
Run the stored procedure to refresh the **BookingCustomerAggregation** table in **Synapse**:

```sql
EXEC airbnb.BookingAggregation;
```

---

## üß† Key Optimizations & Tuning

1. **Change Data Capture (CDC)**: 
   - By using **CDC**, only the data that has changed or is new is ingested. This reduces processing time and resource consumption.
   
2. **Data Distribution & Query Optimization**: 
   - The **Round-Robin Distribution** of the aggregation table ensures data is distributed evenly across compute nodes, enhancing query performance for large datasets.
   
3. **Stored Procedures for Efficiency**:
   - The aggregation logic has been moved to a **stored procedure**, improving execution time, making the process repeatable, and minimizing manual intervention.

4. **Data Archiving**: 
   - Archiving the raw data after ingestion ensures optimized storage management, reducing the costs of long-term storage and improving the pipeline's overall performance.

---

## üîÑ Future Enhancements

- **Power BI Reporting**: Integrate **Power BI** or similar tools to visualize the aggregated data from Synapse.
- **Real-time Streaming**: Migrate the pipeline to incorporate **Azure Stream Analytics** or **Azure Synapse Link for Cosmos DB** for real-time streaming of both **customer** and **booking data**.
- **Error Handling**: Implement advanced **error handling** and **logging** mechanisms in **ADF pipelines** to ensure smooth execution.

---

## Contributions
Contributions are welcome! If you'd like to contribute, please fork the repository and submit a pull request with your enhancements.


## License
This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.


## Acknowledgments
Special thanks to the Azure team for providing the **Data Factory**, **Cosmos DB**, and **Synapse services**, as well as the open-source community for their invaluable contributions to the tools and libraries used.

## üôã‚Äç‚ôÄÔ∏è Author

**Nisha S**  
Azure Data Engineer | Passionate about building scalable data pipelines and optimizing data workflows.

üì´ [LinkedIn Profile](https://www.linkedin.com/in/nisha-s-16410917a/)
